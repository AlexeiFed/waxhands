-- Создание таблицы для политики конфиденциальности
CREATE TABLE IF NOT EXISTS privacy_policies (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    version VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT FALSE,
    created_by INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание индексов для оптимизации запросов
CREATE INDEX IF NOT EXISTS idx_privacy_policies_is_active ON privacy_policies(is_active);
CREATE INDEX IF NOT EXISTS idx_privacy_policies_version ON privacy_policies(version);
CREATE INDEX IF NOT EXISTS idx_privacy_policies_created_by ON privacy_policies(created_by);

-- Вставка начальной политики конфиденциальности
INSERT INTO privacy_policies (title, content, version, is_active, created_by) VALUES (
    'Политика конфиденциальности',
    '<div class="privacy-policy-content">
        <h1>Политика конфиденциальности</h1>
        <p><strong>Дата вступления в силу:</strong> 25 декабря 2024 г.</p>
        <p><strong>Версия:</strong> 1.0</p>
        
        <h2>1. Общие положения</h2>
        <p>Настоящая Политика конфиденциальности (далее – «Политика») определяет порядок обработки персональных данных пользователей приложения «Студия МК ''Восковые ручки''» (далее – «Приложение»), разработанного индивидуальным предпринимателем.</p>
        
        <p>Использование Приложения означает безоговорочное согласие пользователя с настоящей Политикой и указанными в ней условиями обработки персональных данных.</p>
        
        <h2>2. Оператор персональных данных</h2>
        <p><strong>Индивидуальный предприниматель:</strong> [ФИО индивидуального предпринимателя]</p>
        <p><strong>ИНН:</strong> 272210695289</p>
        <p><strong>Телефон:</strong> 8914-545-06-06</p>
        <p><strong>Email:</strong> pavelt80@mail.ru</p>
        
        <h2>3. Категории обрабатываемых персональных данных</h2>
        <p>Приложение обрабатывает следующие категории персональных данных:</p>
        <ul>
            <li><strong>Данные родителей:</strong> имя, фамилия, номер телефона, адрес электронной почты</li>
            <li><strong>Данные детей:</strong> имя, фамилия, возраст, школа, класс, смена обучения</li>
            <li><strong>Данные о заказах:</strong> информация о выбранных услугах, датах проведения мастер-классов, суммах оплаты</li>
            <li><strong>Технические данные:</strong> IP-адрес, данные о браузере, информация об устройстве</li>
        </ul>
        
        <h2>4. Цели обработки персональных данных</h2>
        <p>Персональные данные обрабатываются в следующих целях:</p>
        <ul>
            <li>Предоставление услуг по организации и проведению мастер-классов</li>
            <li>Обработка заявок и регистраций на мастер-классы</li>
            <li>Осуществление расчетов за предоставленные услуги</li>
            <li>Информирование о новых услугах и мероприятиях</li>
            <li>Обеспечение безопасности и предотвращение мошенничества</li>
            <li>Соблюдение требований законодательства РФ</li>
        </ul>
        
        <h2>5. Правовые основания обработки персональных данных</h2>
        <p>Обработка персональных данных осуществляется на основании:</p>
        <ul>
            <li>Согласия субъекта персональных данных (ст. 9 ФЗ-152)</li>
            <li>Исполнения договора, стороной которого является субъект персональных данных (ст. 6 GDPR)</li>
            <li>Соблюдения правовых обязательств оператора (ст. 6 GDPR)</li>
        </ul>
        
        <h2>6. Способы обработки персональных данных</h2>
        <p>Обработка персональных данных осуществляется с использованием:</p>
        <ul>
            <li>Автоматизированных средств (базы данных, информационные системы)</li>
            <li>Смешанных средств (автоматизированных и неавтоматизированных)</li>
        </ul>
        
        <h2>7. Сроки обработки персональных данных</h2>
        <p>Персональные данные обрабатываются в течение следующих сроков:</p>
        <ul>
            <li><strong>Данные пользователей:</strong> до отзыва согласия или удаления аккаунта</li>
            <li><strong>Данные о заказах:</strong> 5 лет с момента последней операции (требования налогового законодательства)</li>
            <li><strong>Технические данные:</strong> 1 год с момента сбора</li>
        </ul>
        
        <h2>8. Передача персональных данных третьим лицам</h2>
        <p>Персональные данные могут передаваться следующим категориям получателей:</p>
        <ul>
            <li>Платежным системам (Яндекс.Касса) – для обработки платежей</li>
            <li>Хостинг-провайдерам – для технического обеспечения работы Приложения</li>
            <li>Государственным органам – в случаях, предусмотренных законодательством РФ</li>
        </ul>
        
        <h2>9. Меры защиты персональных данных</h2>
        <p>Для защиты персональных данных применяются следующие меры:</p>
        <ul>
            <li>Шифрование данных при передаче (HTTPS/TLS)</li>
            <li>Хеширование паролей (bcrypt)</li>
            <li>Ограничение доступа к персональным данным</li>
            <li>Регулярное обновление программного обеспечения</li>
            <li>Мониторинг безопасности</li>
        </ul>
        
        <h2>10. Права субъектов персональных данных</h2>
        <p>Субъекты персональных данных имеют право:</p>
        <ul>
            <li>Получать информацию об обработке своих персональных данных</li>
            <li>Требовать уточнения, блокирования или уничтожения персональных данных</li>
            <li>Отзывать согласие на обработку персональных данных</li>
            <li>Обращаться в уполномоченный орган по защите прав субъектов персональных данных</li>
        </ul>
        
        <h2>11. Использование файлов cookie</h2>
        <p>Приложение использует файлы cookie для:</p>
        <ul>
            <li>Обеспечения функциональности Приложения</li>
            <li>Запоминания пользовательских настроек</li>
            <li>Анализа использования Приложения</li>
            <li>Улучшения пользовательского опыта</li>
        </ul>
        
        <h2>12. Обработка персональных данных несовершеннолетних</h2>
        <p>Обработка персональных данных детей осуществляется только с согласия их законных представителей (родителей).</p>
        
        <h2>13. Изменения в Политике конфиденциальности</h2>
        <p>Оператор вправе вносить изменения в настоящую Политику. При внесении изменений в актуальной редакции указывается дата последнего обновления.</p>
        
        <h2>14. Контактная информация</h2>
        <p>По вопросам обработки персональных данных обращайтесь:</p>
        <ul>
            <li><strong>Телефон:</strong> 8914-545-06-06</li>
            <li><strong>Email:</strong> pavelt80@mail.ru</li>
        </ul>
        
        <h2>15. Заключительные положения</h2>
        <p>Настоящая Политика конфиденциальности составлена в соответствии с требованиями:</p>
        <ul>
            <li>Федерального закона от 27.07.2006 № 152-ФЗ «О персональных данных»</li>
            <li>Общего регламента по защите данных (GDPR)</li>
            <li>Иных применимых нормативных правовых актов РФ</li>
        </ul>
    </div>',
    '1.0',
    TRUE,
    (SELECT id FROM users WHERE role = 'admin' LIMIT 1)
) ON CONFLICT DO NOTHING;
