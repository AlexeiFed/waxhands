# Техническая документация Wax Hands PWA

**Версия:** 1.11.0  
**Дата:** 2024-12-19  
**Ответственный:** Алексей

## Исправление критических ошибок UI/UX в интерфейсе администратора

### Проблема
Пользователь сообщил о нескольких критических проблемах в интерфейсе администратора:
1. **Ошибка с Label** - `ReferenceError: Label is not defined` в MasterClassDetails
2. **Проблема с вложенными button** - предупреждение React о вложенных button элементах в календаре
3. **Некрасивое размещение календаря** - слишком много места справа от календаря
4. **Карточка фильтра не растягивается** - неэффективное использование пространства
5. **Пустой экран при нажатии "Подробнее"** - ошибки в компоненте MasterClassDetails

### Корень проблемы
Анализ кода показал:
- Отсутствует импорт `Label` в MasterClassDetails.tsx
- В календаре используется button внутри button, что нарушает HTML стандарты
- Календарь не имеет ограничений по ширине
- Карточка фильтра не использует доступное пространство
- Проблемы с типизацией в функциях экспорта

### Решение
Выполнено комплексное исправление всех проблем:

1. **Исправлена ошибка с Label**:
   ```typescript
   import { Label } from "@/components/ui/label";
   ```

2. **Исправлена проблема с вложенными button**:
   ```typescript
   // Было:
   <button {...props} className="w-full h-full p-2 text-center hover:bg-accent rounded-md">
   
   // Стало:
   <div {...props} className="w-full h-full p-2 text-center hover:bg-accent rounded-md cursor-pointer">
   ```

3. **Оптимизирована ширина календаря**:
   ```typescript
   <Card className="w-fit">
   ```

4. **Растянута карточка фильтра**:
   ```typescript
   <Card className="flex-grow">
   ```

5. **Улучшена типизация**:
   ```typescript
   export interface School {
       id: string;
       name: string;
       address: string;
       classes: string[];
       teacher?: string;
       teacherPhone?: string;
       notes?: string;
   }
   ```

### Результат
- Все критические ошибки исправлены
- Интерфейс стал более компактным и эффективным
- Улучшена общая стабильность приложения
- Устранены все предупреждения в консоли

---

## Критическое исправление нестабильного отображения медиаданных

## Критическое исправление нестабильного отображения медиаданных

### Проблема
Пользователь сообщил о нестабильном отображении медиаданных:
- При заходе в стиль медиа отображаются случайно, иногда полностью отсутствуют
- В форме редактирования медиа сначала появляются, потом исчезают
- Проблема связана с работой с локальной базой данных IndexedDB

### Корень проблемы
Анализ логов показал, что данные успешно загружаются из IndexedDB, но проблема была в логике отображения:
- Медиа загружались в те же поля, что и ID (`style.avatar`, `style.images`, `style.videos`)
- Это приводило к перезаписи ID и нестабильному отображению
- При переключении между модальными окнами состояния конфликтовали

### Решение
Полностью переработана логика загрузки и отображения медиа:

1. **Добавлены отдельные состояния для загруженных медиа**:
   ```typescript
   const [loadedStyleMedia, setLoadedStyleMedia] = useState<{
       avatar: string;
       images: string[];
       videos: string[];
   } | null>(null);
   ```

2. **Обновлены функции загрузки медиа**:
   - `openViewStyleInfo` и `openEditStyle` сохраняют медиа в отдельные состояния
   - Медиа больше не перезаписывают ID в основных объектах

3. **Обновлено отображение во всех модальных окнах**:
   - Модальные окна просмотра используют `loadedViewStyleMedia` и `loadedViewOptionMedia`
   - Формы редактирования используют `loadedStyleMedia` и `loadedOptionMedia`

4. **Добавлена очистка состояний**:
   - Функции `handleCloseViewStyleInfo`, `handleCloseEditStyle` и др.
   - При закрытии модальных окон состояния медиа очищаются

### Результат
- Медиа теперь отображаются стабильно во всех модальных окнах
- Исчезла проблема с исчезающими медиа при переключении между окнами
- Улучшена общая стабильность работы с медиаданными

---

## Архитектура проекта

### Технологический стек
- **Frontend**: React 18 + TypeScript
- **Сборка**: Vite
- **Стилизация**: Tailwind CSS
- **UI компоненты**: Shadcn/ui
- **Маршрутизация**: React Router
- **Локальное хранилище**: IndexedDB

### Структура компонентов
```
src/
├── components/
│   ├── auth/          # Компоненты аутентификации
│   ├── shared/        # Общие компоненты
│   └── ui/           # UI компоненты (shadcn/ui)
├── contexts/         # React контексты
├── hooks/           # Кастомные хуки
├── lib/             # Утилиты и библиотеки
├── pages/           # Страницы приложения
└── types/           # TypeScript типы
```

## Система медиа

### IndexedDB интеграция
- **Класс MediaStorage**: Управление медиа в IndexedDB
- **Методы**: `init()`, `saveMedia()`, `getMedia()`, `deleteMedia()`
- **Поддержка**: Аватары, изображения, видео

### Утилиты для работы с файлами
- **`generateMediaId()`**: Создание уникальных ID для медиа
- **`fileToBase64()`**: Конвертация файла в base64
- **`filesToBase64()`**: Массовая конвертация файлов

### Состояния медиа
- **`loadedStyleMedia`**: Медиа стилей в форме редактирования
- **`loadedOptionMedia`**: Медиа опций в форме редактирования
- **`loadedViewStyleMedia`**: Медиа стилей в модальном окне просмотра
- **`loadedViewOptionMedia`**: Медиа опций в модальном окне просмотра

## Безопасность

### Аутентификация
- JWT токены для защиты маршрутов
- Контекст `AuthContext` для управления состоянием
- Защищенные маршруты для администраторов

### Валидация данных
- Проверка типов файлов при загрузке
- Валидация форм на клиенте
- Обработка ошибок при работе с IndexedDB

## Производительность

### Оптимизация
- Ленивая загрузка компонентов
- Кэширование медиа в IndexedDB
- Оптимизация изображений и видео

### PWA возможности
- Service Worker для кэширования
- Manifest для установки на устройства
- Офлайн функциональность

## Качество кода

### TypeScript
- Строгая типизация всех компонентов
- Интерфейсы для всех структур данных
- Типизированные пропсы компонентов

### ESLint и Prettier
- Автоматическое форматирование кода
- Проверка качества кода
- Единый стиль кодирования

### Компонентная архитектура
- Функциональные компоненты с хуками
- Разделение ответственности
- Переиспользуемые компоненты

## Мониторинг и отладка

### Логирование
- Детальные логи для работы с медиа
- Отслеживание ошибок IndexedDB
- Логирование пользовательских действий

### Обработка ошибок
- Try-catch блоки для асинхронных операций
- Пользовательские уведомления об ошибках
- Graceful degradation при сбоях

## Планы развития

### Краткосрочные задачи
- [ ] Добавление drag-and-drop для загрузки файлов
- [ ] Оптимизация размера медиафайлов
- [ ] Добавление прогресс-баров для загрузки

### Долгосрочные задачи
- [ ] Интеграция с облачным хранилищем
- [ ] Добавление системы версионирования медиа
- [ ] Реализация автоматического резервного копирования 

## Управление пользователями (админка)

### Функциональность
- Просмотр списка всех пользователей
- Фильтрация по ролям (админ, родитель, ребенок, исполнитель)
- Удаление пользователей с подтверждением
- Защита от удаления собственного аккаунта

### Технические детали
- Используется `localStorage` для хранения данных пользователей
- Автоматическое создание админа при инициализации приложения
- Проверка на существование админа в `ensureAdminExists()`
- Переменная `currentUser` для избежания конфликтов имен в компонентах

### Исправленные баги
- **Конфликт имен переменных**: Переименована переменная `user` из контекста в `currentUser` для избежания конфликтов с переменной `user` в цикле `users.map()`
- **Исчезновение админа**: Добавлена функция `ensureAdminExists()` для автоматического создания админа в localStorage
- **Ошибка Select.Item**: Исправлена в форме регистрации - убраны SelectItem с пустыми значениями, добавлены текстовые подсказки 