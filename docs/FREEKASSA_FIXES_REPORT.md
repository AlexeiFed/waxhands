# üîß –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö FreekassaProvider

**–î–∞—Ç–∞:** 2024-10-16  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ FreeKassa –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `FreekassaProvider`. –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã **–¢–û–õ–¨–ö–û** –∫ FreeKassa, –∫–æ–¥ Robokassa –æ—Å—Ç–∞–ª—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º –±–ª–∞–≥–æ–¥–∞—Ä—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Strategy Pattern.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **API Endpoints**
- ‚ùå **–ë—ã–ª–æ:** `https://api.freekassa.net/v1/...`
- ‚úÖ **–°—Ç–∞–ª–æ:** `https://api.fk.life/v1/...`

### 2. **URL –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã**
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** `https://pay.fk.money/` (–±—ã–ª–æ –≤–µ—Ä–Ω–æ, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### 3. **–ü–æ–¥–ø–∏—Å—å –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã (MD5)**
- ‚ùå **–ë—ã–ª–æ:** `MD5(merchantId:amount:secretWord1:orderId)`
- ‚úÖ **–°—Ç–∞–ª–æ:** `MD5(merchantId:amount:secretWord1:currency:orderId)`
- üìù **–î–æ–±–∞–≤–ª–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä:** `currency`

### 4. **–ü–æ–¥–ø–∏—Å—å –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤**
- ‚ùå **–ë—ã–ª–æ:** MD5 —Ö–µ—à
- ‚úÖ **–°—Ç–∞–ª–æ:** HMAC-SHA256 —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- üìù **–ê–ª–≥–æ—Ä–∏—Ç–º:**
  1. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –∫–ª—é—á–∞–º –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
  2. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å `|`
  3. –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ HMAC-SHA256 —Å API –∫–ª—é—á–æ–º

### 5. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞—Ç–µ–∂–∞**
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã:**
  - `currency` - –≤–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  - `i` - –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 6. **API –≤–æ–∑–≤—Ä–∞—Ç–æ–≤**
- ‚ùå **–ë—ã–ª–æ:** `https://api.freekassa.net/v1/refund`
- ‚úÖ **–°—Ç–∞–ª–æ:** `https://api.fk.life/v1/orders/refund`
- ‚úÖ **–ü–æ–¥–ø–∏—Å—å:** HMAC-SHA256 (–≤–º–µ—Å—Ç–æ MD5)

### 7. **–°—Ç–∞—Ç—É—Å –≤–æ–∑–≤—Ä–∞—Ç–∞**
- ‚ùå **–ë—ã–ª–æ:** `GET /refund/{requestId}`
- ‚úÖ **–°—Ç–∞–ª–æ:** `GET /orders?order_id={requestId}&signature={signature}`

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend
1. `backend/src/payments/providers/FreekassaProvider.ts`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –ø–æ–¥–ø–∏—Å–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã API endpoints
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
2. `docs/FREEKASSA_QUICK_SETUP.md`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å—è—Ö
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã
   - –£–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL

3. `docs/FREEKASSA_FIXES_REPORT.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
   - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

## üîê –ê–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ–¥–ø–∏—Å–∏

### –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Ñ–æ—Ä–º–∞ (MD5)
```typescript
const signatureString = `${merchantId}:${amount}:${secretWord1}:${currency}:${orderId}`;
const signature = crypto.createHash('md5').update(signatureString).digest('hex');
```

**–ü—Ä–∏–º–µ—Ä:**
```
MD5(66509:1000.00:uqlTWAXu^hgw{Nq:RUB:12345) = abc123def456...
```

### Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (MD5)
```typescript
const signatureString = `${MERCHANT_ID}:${AMOUNT}:${secretWord2}:${MERCHANT_ORDER_ID}`;
const signature = crypto.createHash('md5').update(signatureString).digest('hex');
```

**–ü—Ä–∏–º–µ—Ä:**
```
MD5(66509:1000.00:s--vO&HvNfKxsyO:12345) = xyz789abc123...
```

### API –∑–∞–ø—Ä–æ—Å—ã (HMAC-SHA256)
```typescript
// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –∫–ª—é—á–∞–º
const sortedKeys = Object.keys(data).sort();
const values = sortedKeys.map(key => String(data[key]));
const signatureString = values.join('|');

// –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ HMAC-SHA256
const signature = crypto
    .createHmac('sha256', apiKey)
    .update(signatureString)
    .digest('hex');
```

**–ü—Ä–∏–º–µ—Ä:**
```javascript
// –î–∞–Ω–Ω—ã–µ: { amount: "1000.00", order_id: "12345" }
// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ["amount", "order_id"]
// –ó–Ω–∞—á–µ–Ω–∏—è: ["1000.00", "12345"]
// –°—Ç—Ä–æ–∫–∞: "1000.00|12345"
// HMAC-SHA256(—Å—Ç—Ä–æ–∫–∞, apiKey) = signature
```

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
cd /var/www/waxhands-app/backend
git pull origin main
npm run build
pm2 restart waxhands-backend
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
pm2 logs waxhands-backend --lines 100
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

### –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è FreeKassa:
```env
PAYMENT_PROVIDER=freekassa
```

### –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Robokassa:
```env
PAYMENT_PROVIDER=robokassa
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ö–æ–¥ Robokassa –ù–ï –∏–∑–º–µ–Ω–∏–ª—Å—è** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ `FreekassaProvider`
2. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Strategy Pattern** –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã Robokassa –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ FreeKassa
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ —á–µ—Ä–µ–∑ API
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2024-10-16  
**–í–µ—Ä—Å–∏—è:** 1.0


