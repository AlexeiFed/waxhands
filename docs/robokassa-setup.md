# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Robokassa

## üìã –û–±–∑–æ—Ä

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Robokassa –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è–º –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É. –§—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å email `23alex08@mail.ru`.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª `backend/.env`:

```env
# Robokassa Configuration
ROBOKASSA_MERCHANT_LOGIN=robo-demo-test
ROBOKASSA_PASSWORD_1=password_1
ROBOKASSA_PASSWORD_2=password_2
ROBOKASSA_PASSWORD_3=password_3
ROBOKASSA_TEST_MODE=true
ROBOKASSA_SUCCESS_URL=https://waxhands.ru/payment/robokassa/success
ROBOKASSA_FAIL_URL=https://waxhands.ru/payment/robokassa/fail
ROBOKASSA_RESULT_URL=https://waxhands.ru/api/payment-webhook/robokassa
ROBOKASSA_ALGORITHM=MD5
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π Robokassa:

```bash
cd backend
npm run migrate:robokassa
```

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤—Ä—É—á–Ω—É—é:

```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ robokassa_invoice_id
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS robokassa_invoice_id VARCHAR(255);

-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ refund_available_until –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS refund_available_until TIMESTAMP WITH TIME ZONE;

-- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –¥–ª—è robokassa_invoice_id
CREATE INDEX IF NOT EXISTS idx_invoices_robokassa_invoice_id 
ON invoices(robokassa_invoice_id);
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ Robokassa

1. –ó–∞–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Robokassa](https://partner.robokassa.ru/)
2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω
3. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏:
   - **–ü–∞—Ä–æ–ª—å #1** - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ–ø–ª–∞—Ç—É
   - **–ü–∞—Ä–æ–ª—å #2** - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - **–ü–∞—Ä–æ–ª—å #3** - –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞—è–≤–∫–∏)

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞ Robokassa —É–∫–∞–∂–∏—Ç–µ:

- **Result URL**: `https://waxhands.ru/api/payment-webhook/robokassa`
- **Success URL**: `https://waxhands.ru/payment/robokassa/success`
- **Fail URL**: `https://waxhands.ru/payment/robokassa/fail`

## üöÄ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –û–ø–ª–∞—Ç–∞

- **–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è**: `23alex08@mail.ru`
- **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã**: –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –°–ë–ü
- **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: iframe –±–µ–∑ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–§–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –§–ó-54

### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

- **–£—Å–ª–æ–≤–∏–µ**: –î–æ 3 —á–∞—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞
- **–°–ø–æ—Å–æ–±**: –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–∞

### –§–∏—Å–∫–∞–ª—å–Ω—ã–µ —á–µ–∫–∏

–ß–µ–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π:

- **–û—Å–Ω–æ–≤–Ω–∞—è —É—Å–ª—É–≥–∞**: –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å (–ù–î–° 20%)
- **–°—Ç–∏–ª–∏**: –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–ù–î–° 20%)
- **–û–ø—Ü–∏–∏**: –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–ù–î–° 20%)

## üì° API Endpoints

### –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
```
POST /api/robokassa/invoices/:invoiceId/pay
Authorization: Bearer <token>
```

### Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```
POST /api/payment-webhook/robokassa
POST /api/payment-webhook/robokassa/jws
```

### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
```
POST /api/robokassa/invoices/:invoiceId/refund
Authorization: Bearer <token>
Body: { "opKey": "string", "refundSum": number }
```

### –°—Ç–∞—Ç—É—Å –≤–æ–∑–≤—Ä–∞—Ç–∞
```
GET /api/robokassa/refunds/:requestId/status
Authorization: Bearer <token>
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π**: –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ –ø–æ–¥–ø–∏—Å–∏
- **JWT —Ç–æ–∫–µ–Ω—ã**: –î–ª—è API Robokassa –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è JWT —Ç–æ–∫–µ–Ω—ã
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞**: –û–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

- **Email**: `23alex08@mail.ru`
- **–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Robokassa
- **–°—É–º–º—ã**: –õ—é–±—ã–µ —Å—É–º–º—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Ç–µ—Å—Ç–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
2. –°–æ–∑–¥–∞–π—Ç–µ —Å—á–µ—Ç –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å
3. –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Robokassa"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ iframe —Å —Ñ–æ—Ä–º–æ–π –æ–ø–ª–∞—Ç—ã
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–∞

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:

- `üîÑ` - –ù–∞—á–∞–ª–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `‚úÖ` - –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- `‚ùå` - –û—à–∏–±–∫–∞
- `üîç` - –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞ "–û–ø–ª–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

### –û—à–∏–±–∫–∞ "–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π –≤ .env
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º

### iframe –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL Robokassa –¥–æ—Å—Ç—É–ø–µ–Ω

### –°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Robokassa
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Robokassa
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Robokassa
4. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º:

1. –ü–æ–ª—É—á–∏—Ç–µ –±–æ–µ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –æ—Ç Robokassa
2. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `ROBOKASSA_TEST_MODE=false`
4. –û–±–Ω–æ–≤–∏—Ç–µ URL –Ω–∞ –±–æ–µ–≤—ã–µ –¥–æ–º–µ–Ω—ã
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–∞—Ö
6. –†–∞—Å—à–∏—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
